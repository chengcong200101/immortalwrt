name: Build ImmortalWrt 24.10.4 Firmware

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  FIRMWARE_NAME: ImmortalWrt-24.10.4-x86-64-Custom

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Check available disk space
      run: |
        echo "=== Checking disk space ==="
        df -h
        AVAILABLE_KB=$(df / --output=avail | tail -1)
        REQUIRED_KB=15000000  # 降低到15GB要求
        if [ $AVAILABLE_KB -lt $REQUIRED_KB ]; then
          echo "Warning: Limited disk space, only $((AVAILABLE_KB / 1024 / 1024))GB available"
          echo "We'll try to build with limited space, but may fail"
        else
          echo "Disk space sufficient: $((AVAILABLE_KB / 1024 / 1024))GB available"
        fi

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clean up system space
      run: |
        echo "=== Cleaning up system space ==="
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo journalctl --vacuum-size=50M
        docker system prune -af 2>/dev/null || true
        # 清理其他缓存
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*

    - name: Install minimal build dependencies
      timeout-minutes: 10
      run: |
        echo "=== Installing minimal build dependencies ==="
        sudo apt-get update
        
        # 只安装最必要的依赖
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          subversion
        
        sudo apt-get clean
        echo "Dependencies installed successfully"

    - name: Clone ImmortalWrt source (shallow)
      timeout-minutes: 5
      run: |
        echo "=== Cloning ImmortalWrt source (shallow) ==="
        # 使用极浅克隆节省空间
        git clone https://github.com/immortalwrt/immortalwrt.git --depth=1 --branch=v24.10.4
        
        if [ $? -ne 0 ]; then
          echo "Clone failed, trying master branch"
          git clone https://github.com/immortalwrt/immortalwrt.git --depth=1
          cd immortalwrt
        else
          cd immortalwrt
        fi
        
        echo "Source preparation completed"

    - name: Update and install feeds (minimal)
      timeout-minutes: 15
      run: |
        echo "=== Updating and installing minimal feeds ==="
        cd immortalwrt
        
        # 只更新必要的feeds
        ./scripts/feeds update packages luci routing telephony
        ./scripts/feeds install -a
        
        echo "Feeds installation completed"

    - name: Create minimal configuration
      run: |
        echo "=== Creating minimal configuration ==="
        cd immortalwrt
        
        # 创建最小化配置，只包含必需的插件
        {
          echo "CONFIG_TARGET_x86=y"
          echo "CONFIG_TARGET_x86_64=y"
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y"
          echo ""
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
          echo "CONFIG_TARGET_IMAGES_GZIP=y"
          echo ""
          # 最小化内核模块
          echo "CONFIG_PACKAGE_kmod-usb-core=y"
          echo "CONFIG_PACKAGE_kmod-usb-storage=y"
          echo "CONFIG_PACKAGE_kmod-usb2=y"
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y"
          echo "CONFIG_PACKAGE_kmod-fs-vfat=y"
          echo ""
          # 网络基础
          echo "CONFIG_PACKAGE_dnsmasq=y"
          echo "CONFIG_PACKAGE_firewall=y"
          echo "CONFIG_PACKAGE_iptables=y"
          echo ""
          # LUCI基础
          echo "CONFIG_PACKAGE_luci=y"
          echo "CONFIG_PACKAGE_luci-base=y"
          echo "CONFIG_PACKAGE_luci-compat=y"
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y"
          echo ""
          # 只选择最需要的几个插件
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y"
          echo "CONFIG_PACKAGE_luci-app-firewall=y"
          echo "CONFIG_PACKAGE_luci-app-upnp=y"
          echo "CONFIG_PACKAGE_luci-app-wol=y"
          echo "CONFIG_PACKAGE_luci-app-zerotier=y"
          echo "CONFIG_PACKAGE_luci-theme-argon=y"
          echo ""
          # 必要的依赖
          echo "CONFIG_PACKAGE_adguardhome=y"
          echo "CONFIG_PACKAGE_zerotier=y"
          echo "CONFIG_PACKAGE_wol=y"
          echo ""
          echo "CONFIG_CCACHE=y"
        } > .config

        echo "Minimal configuration created successfully"

    - name: Download package sources
      timeout-minutes: 20
      run: |
        echo "=== Downloading package sources ==="
        cd immortalwrt
        
        make defconfig
        
        for i in 1 2 3; do
          echo "Downloading packages (attempt $i)..."
          make download -j4
          if [ $? -eq 0 ]; then
            echo "Package download successful"
            break
          else
            echo "Package download failed, retrying..."
            sleep 10
          fi
        done

    - name: Build toolchain
      timeout-minutes: 45
      run: |
        echo "=== Building toolchain ==="
        cd immortalwrt
        
        echo "Building toolchain..."
        make toolchain/compile -j2 V=s

    - name: Build firmware (single thread)
      timeout-minutes: 120
      run: |
        echo "=== Building firmware ==="
        cd immortalwrt
        
        echo "Disk space before build:"
        df -h
        
        echo "Starting firmware build (single thread to save memory)..."
        # 使用单线程编译节省内存和空间
        make -j1 V=s 2>&1 | tee build.log
        
        echo "=== Checking build results ==="
        if ls bin/targets/x86/64/*.img.gz 1> /dev/null 2>&1; then
          echo "Firmware build successful!"
          ls -la bin/targets/x86/64/*.img.gz
          echo "FIRMWARE_BUILT=true" >> $GITHUB_ENV
        else
          echo "Firmware build failed"
          echo "Check build.log for errors"
          echo "FIRMWARE_BUILT=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Upload firmware artifacts
      if: env.FIRMWARE_BUILT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          immortalwrt/bin/targets/x86/64/*.img.gz
          immortalwrt/bin/targets/x86/64/sha256sums
        retention-days: 30
        if-no-files-found: error

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/.config
        retention-days: 7

    - name: Notify build status
      if: always()
      run: |
        echo "=== Build Status ==="
        if [ "$FIRMWARE_BUILT" = "true" ]; then
          echo "Build completed successfully!"
          echo "Firmware can be downloaded from Artifacts"
        else
          echo "Build failed"
          echo "Please check build-logs for details"
        fi
