name: ImmortalWrt x86 Build

on:
  workflow_dispatch:
    inputs:
      CACHE_BUILD:
        description: "ç¼“å­˜åŠ é€Ÿ"
        required: false
        default: true
        type: boolean

  schedule:
    - cron: 30 17 * * *

run-name: >-
  ${{ github.event_name == 'workflow_dispatch'
      && 'ç¼–è¯‘ ImmortalWrt x86 å›ºä»¶'
      || 'è‡ªåŠ¨ç¼–è¯‘ ImmortalWrt x86 å›ºä»¶' }}

env:
  TZ: Asia/Shanghai
  MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
  GITHUB_RELEASE: https://github.com/${{ github.repository }}/releases

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id

    name: ç¼–è¯‘ ImmortalWrt x86 å›ºä»¶
    strategy:
      fail-fast: false

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: æ£€æµ‹è„šæœ¬è®¾ç½®
        run: |
          SETTINGS_FILE="${GITHUB_WORKSPACE}/build/immortalwrt_x86/settings.ini"
          if [ ! -f "$SETTINGS_FILE" ]; then
            echo "âŒ é”™è¯¯: settings.ini æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          while IFS='=' read -r key value; do
            if [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            value=$(echo "$value" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")
            echo "${key}=${value}" >> $GITHUB_ENV
          done < "$SETTINGS_FILE"
          
          echo "HOME=${GITHUB_WORKSPACE}/immortalwrt" >> $GITHUB_ENV
          echo "WORKPATH=${GITHUB_WORKSPACE}/immortalwrt/build/immortalwrt_x86" >> $GITHUB_ENV
          echo "UPLOAD_TARGETS=true" >> $GITHUB_ENV

      - name: åˆå§‹åŒ–ç³»ç»ŸçŽ¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt update -y
          sudo -E apt full-upgrade -y
          sudo -E apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
                     bzip2 ccache clang cmake cpio curl device-tree-compiler ecj flex gawk gcc-multilib \
                     g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-i386 libelf-dev \
                     libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev \
                     libreadline-dev libssl-dev libpython3-dev libtool libyaml-dev libz-dev lld llvm lrzsz msmtp \
                     ninja-build p7zip p7zip-full patch pkgconf python3 python3-ply python3-docutils \
                     python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
                     upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd libfuse-dev gettext genisoimage uuid-dev python3-setuptools

      - name: ç¼–è¯‘å‰å‡†å¤‡
        run: |
          sudo -E apt-get -y install xsltproc zip grep python3-pip libc6-dev libtinfo-dev ncurses-doc \
                      git-core wget curl rsync dos2unix fakeroot jq libncurses5-dev libncursesw5-dev quilt file g++

      - name: é‡Šæ”¾Ubuntuç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          docker-images: true
          swap-storage: true

      - name: æ‰©å±•å·¥ä½œç©ºé—´
        run: |
          echo "æ‰©å±•å·¥ä½œç©ºé—´..."
          extra_space=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 2)
          if [ $extra_space -lt 10 ]; then
            extra_space=10
          fi
          echo "åˆ›å»º ${extra_space}GB é¢å¤–ç©ºé—´"
          
          sudo dd if=/dev/zero of=/mnt/extra.img bs=1G count=$extra_space status=progress
          sudo mkfs.ext4 /mnt/extra.img
          sudo mkdir -p /github-builder
          sudo mount /mnt/extra.img /github-builder
          sudo chown -R $USER:$GROUPS /github-builder
          
          echo "æ‰©å±•åŽç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: ä¸‹è½½ImmortalWrtæºç 
        working-directory: /github-builder
        run: |
          git clone -b $REPO_BRANCH --single-branch $REPO_URL immortalwrt
          ln -sf /github-builder/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: ç¼“å­˜åŠ é€Ÿ
        uses: xcz-ns/cachewrtbuild@main
        if: env.CACHE_BUILD == 'true'
        with:
          ccache: "true"
          prefix: ${{ github.workspace }}/immortalwrt
          mixkey: ${{ env.FIRMWARE_MESSAGE }}

      - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
        id: date
        run: |
          echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
          echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
          echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV

      - name: åŠ è½½é…ç½®
        run: |
          cp -Rf build immortalwrt/
          cd immortalwrt
          mv ${WORKPATH}/$CONFIG_FILE .config
          make defconfig

      - name: æ¸…ç†ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          cd immortalwrt
          echo "æ¸…ç†ç¼–è¯‘çŽ¯å¢ƒ..."
          rm -rf tmp/
          rm -rf staging_dir/target-x86_64_musl/stamp/.package_*
          make clean

      - name: æ£€æŸ¥å¹¶ä¿®å¤ä¾èµ–
        run: |
          cd immortalwrt
          echo "æ£€æŸ¥ä¾èµ–å…³ç³»..."
          make defconfig
          
          # ä¸‹è½½æ‰€æœ‰éœ€è¦çš„åŒ…
          echo "ä¸‹è½½æ‰€éœ€æ–‡ä»¶..."
          make download -j4

      - name: åˆ†æ­¥ç¼–è¯‘
        id: compile
        run: |
          cd immortalwrt
          echo "å¼€å§‹åˆ†æ­¥ç¼–è¯‘..."
          
          # æ­¥éª¤1: ç¼–è¯‘å·¥å…·é“¾
          echo "æ­¥éª¤1: ç¼–è¯‘å·¥å…·é“¾..."
          if make toolchain/install -j$(nproc); then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            make toolchain/install -j1 V=s
          fi
          
          # æ­¥éª¤2: ç¼–è¯‘å†…æ ¸
          echo "æ­¥éª¤2: ç¼–è¯‘å†…æ ¸..."
          if make target/linux/install -j$(nproc); then
            echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥"
            make target/linux/install -j1 V=s
          fi
          
          # æ­¥éª¤3: å°è¯•ç›´æŽ¥ç¼–è¯‘å®Œæ•´ç³»ç»Ÿ
          echo "æ­¥éª¤3: ç›´æŽ¥ç¼–è¯‘å®Œæ•´ç³»ç»Ÿ..."
          if make -j$(nproc) IGNORE_ERRORS=m; then
            echo "âœ… å®Œæ•´ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ å®Œæ•´ç¼–è¯‘æœ‰é”™è¯¯ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make -j1 V=s IGNORE_ERRORS=m; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å¿½ç•¥é”™è¯¯ç»§ç»­..."
              # å³ä½¿æœ‰é”™è¯¯ä¹Ÿå°è¯•ç”Ÿæˆé•œåƒ
              make -j1 V=s IGNORE_ERRORS=m || echo "ç¼–è¯‘å®Œæˆï¼ˆæœ‰é”™è¯¯ï¼‰"
            fi
          fi

      - name: æ£€æŸ¥ç¼–è¯‘ç»“æžœ
        if: always()
        run: |
          cd immortalwrt
          echo "æ£€æŸ¥ç¼–è¯‘ç»“æžœ..."
          if [ -d "bin/targets/x86/64" ]; then
            echo "âœ… ç¼–è¯‘ç›®æ ‡ç›®å½•å­˜åœ¨"
            ls -la bin/targets/x86/64/
            echo "COMPILE_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘ç›®æ ‡ç›®å½•ä¸å­˜åœ¨"
            echo "COMPILE_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: env.COMPILE_SUCCESS == 'true'
        run: |
          mkdir -p ./artifact/firmware
          mkdir -p ./artifact/targets
          cp -rf $(find immortalwrt/bin/targets/ -type f \( -name "*squashfs*efi*img*" -o -name "*squashfs*sysupgrade*bin*" -o -name "*squashfs*factory*bin*" \) ) ./artifact/firmware/ || true
          cp -rf immortalwrt/bin/targets/ ./artifact/targets/ || true
          
          END_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          END_SECONDS=$(date --date="$END_TIME" +%s)
          SECONDS=$((END_SECONDS - ${{ env.START_SECONDS }}))
          HOUR=$(( $SECONDS/3600 ))
          MIN=$(( ($SECONDS-${HOUR}*3600)/60 ))
          SEC=$(( $SECONDS-${HOUR}*3600-${MIN}*60 ))
          echo "BUILD_TIME=${HOUR}æ—¶${MIN}åˆ†${SEC}ç§’" >> $GITHUB_ENV

      - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        if: env.COMPILE_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_x86_firmware_${{ env.FILE_TIME }}
          path: ./artifact/firmware/

      - name: ä¸Šä¼ targetsæ–‡ä»¶å¤¹
        if: env.COMPILE_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_x86_targets_${{ env.FILE_TIME }}
          path: ./artifact/targets/

      - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
        if: env.COMPILE_SUCCESS == 'true'
        uses: ncipollo/release-action@main
        with:
          name: ${{ env.FILE_TIME1 }} ã€Œ ${{ env.FIRMWARE_MESSAGE }} ã€
          tag: ${{ env.FILE_TIME2 }}-immortalwrt-x86
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          body: |
            â˜…  æºç  : ${{ env.REPO_URL }}
            â˜…  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜…  å›ºä»¶ç±»åž‹ : ImmortalWrt 24.10.4 x86

            ðŸ–¥ å†…æ ¸ç‰ˆæœ¬ï¼š6.6

            ðŸŽˆ ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_TIME1 }}

            â° ç¼–è¯‘ç”¨æ—¶ï¼š${{ env.BUILD_TIME }}

            ðŸš€ ç‰¹è‰²åŠŸèƒ½ï¼šåŸºç¡€ç½‘ç»œåŠ é€Ÿ

          artifacts: ./artifact/firmware/*

      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          sudo umount /github-builder 2>/dev/null || true
          sudo rm -f /mnt/extra.img 2>/dev/null || true
