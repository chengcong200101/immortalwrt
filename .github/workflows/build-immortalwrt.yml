name: ImmortalWrt x86 Build

on:
  workflow_dispatch:
    inputs:
      CACHE_BUILD:
        description: "ç¼“å­˜åŠ é€Ÿ"
        required: false
        default: true
        type: boolean

  # å®šæ—¶è§¦å‘ç¼–è¯‘(åŒ—äº¬æ—¶é—´ï¼šæ¯å¤©æ—©2ç‚¹)
  schedule:
    - cron: 30 17 * * *

run-name: >-
  ${{ github.event_name == 'workflow_dispatch'
      && 'ç¼–è¯‘ ImmortalWrt x86 å›ºä»¶'
      || 'è‡ªåŠ¨ç¼–è¯‘ ImmortalWrt x86 å›ºä»¶' }}

env:
  TZ: Asia/Shanghai
  MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
  GITHUB_RELEASE: https://github.com/${{ github.repository }}/releases

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id

    name: ç¼–è¯‘ ImmortalWrt x86 å›ºä»¶
    strategy:
      fail-fast: false

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: æ£€æµ‹è„šæœ¬è®¾ç½®
        run: |
          SETTINGS_FILE="${GITHUB_WORKSPACE}/build/immortalwrt_x86/settings.ini"
          if [ ! -f "$SETTINGS_FILE" ]; then
            echo "âŒ é”™è¯¯: settings.ini æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼åŠ è½½é…ç½®
          while IFS='=' read -r key value; do
            if [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            value=$(echo "$value" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")
            echo "${key}=${value}" >> $GITHUB_ENV
          done < "$SETTINGS_FILE"
          
          echo "HOME=${GITHUB_WORKSPACE}/immortalwrt" >> $GITHUB_ENV
          echo "WORKPATH=${GITHUB_WORKSPACE}/immortalwrt/build/immortalwrt_x86" >> $GITHUB_ENV
          echo "UPLOAD_TARGETS=true" >> $GITHUB_ENV

      - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt update -y
          sudo -E apt full-upgrade -y
          sudo -E apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
                     bzip2 ccache clang cmake cpio curl device-tree-compiler ecj flex gawk gcc-multilib \
                     g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-i386 libelf-dev \
                     libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev \
                     libreadline-dev libssl-dev libpython3-dev libtool libyaml-dev libz-dev lld llvm lrzsz msmtp \
                     ninja-build p7zip p7zip-full patch pkgconf python3 python3-ply python3-docutils \
                     python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
                     upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd libfuse-dev gettext genisoimage uuid-dev python3-setuptools

      - name: ç¼–è¯‘å‰å‡†å¤‡
        run: |
          sudo -E apt-get -y install xsltproc zip grep python3-pip libc6-dev libtinfo-dev ncurses-doc \
                      git-core wget curl rsync dos2unix fakeroot jq libncurses5-dev libncursesw5-dev quilt file g++

      - name: é‡Šæ”¾Ubuntuç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          docker-images: true
          swap-storage: true

      - name: åˆ›å»ºæ¨¡æ‹Ÿç‰©ç†ç£ç›˜
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /github-builder
          sudo mount /dev/github/runner /github-builder
          sudo chown -R $USER:$GROUPS /github-builder

      - name: ä¸‹è½½ImmortalWrtæºç 
        working-directory: /github-builder
        run: |
          git clone -b $REPO_BRANCH --single-branch $REPO_URL immortalwrt
          ln -sf /github-builder/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: ç¼“å­˜åŠ é€Ÿ
        uses: xcz-ns/cachewrtbuild@main
        if: env.CACHE_BUILD == 'true'
        with:
          ccache: "true"
          prefix: ${{ github.workspace }}/immortalwrt
          mixkey: ${{ env.FIRMWARE_MESSAGE }}

      - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
        id: date
        run: |
          echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
          echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
          echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV

      - name: åŠ è½½é…ç½®
        run: |
          cp -Rf build immortalwrt/
          cd immortalwrt
          mv ${WORKPATH}/$CONFIG_FILE .config
          make defconfig

      - name: æ£€æŸ¥å¹¶ä¿®å¤ä¾èµ–
        run: |
          cd immortalwrt
          echo "æ£€æŸ¥ä¾èµ–å…³ç³»..."
          make defconfig
          
          # ä¸‹è½½æ‰€æœ‰éœ€è¦çš„åŒ…
          echo "ä¸‹è½½æ‰€éœ€æ–‡ä»¶..."
          make download -j4

      - name: åˆ†æ­¥ç¼–è¯‘
        id: compile
        run: |
          cd immortalwrt
          echo "å¼€å§‹åˆ†æ­¥ç¼–è¯‘..."
          
          # æ­¥éª¤1: ç¼–è¯‘å·¥å…·é“¾
          echo "æ­¥éª¤1: ç¼–è¯‘å·¥å…·é“¾..."
          if make toolchain/install -j$(nproc); then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          # æ­¥éª¤2: ç¼–è¯‘ç›®æ ‡å·¥å…·
          echo "æ­¥éª¤2: ç¼–è¯‘ç›®æ ‡å·¥å…·..."
          if make target/compile -j$(nproc); then
            echo "âœ… ç›®æ ‡ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ç›®æ ‡ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          # æ­¥éª¤3: ç¼–è¯‘åŒ…
          echo "æ­¥éª¤3: ç¼–è¯‘åŒ…..."
          if make package/compile -j$(nproc); then
            echo "âœ… åŒ…ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ åŒ…ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make package/compile -j1 V=s
          fi
          
          # æ­¥éª¤4: å®Œæ•´å®‰è£…
          echo "æ­¥éª¤4: å®Œæ•´å®‰è£…..."
          if make package/install -j$(nproc); then
            echo "âœ… åŒ…å®‰è£…æˆåŠŸ"
          else
            echo "âŒ åŒ…å®‰è£…å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹å®‰è£…..."
            make package/install -j1 V=s
          fi
          
          # æ­¥éª¤5: ç”Ÿæˆé•œåƒ
          echo "æ­¥éª¤5: ç”Ÿæˆé•œåƒ..."
          if make target/install -j$(nproc); then
            echo "âœ… é•œåƒç”ŸæˆæˆåŠŸ"
          else
            echo "âŒ é•œåƒç”Ÿæˆå¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç”Ÿæˆ..."
            make target/install -j1 V=s
          fi

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: steps.compile.outcome == 'success'
        run: |
          mkdir -p ./artifact/firmware
          mkdir -p ./artifact/targets
          cp -rf $(find immortalwrt/bin/targets/ -type f \( -name "*squashfs*efi*img*" -o -name "*squashfs*sysupgrade*bin*" -o -name "*squashfs*factory*bin*" \) ) ./artifact/firmware/ || true
          cp -rf immortalwrt/bin/targets/ ./artifact/targets/ || true
          
          END_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          END_SECONDS=$(date --date="$END_TIME" +%s)
          SECONDS=$((END_SECONDS - ${{ env.START_SECONDS }}))
          HOUR=$(( $SECONDS/3600 ))
          MIN=$(( ($SECONDS-${HOUR}*3600)/60 ))
          SEC=$(( $SECONDS-${HOUR}*3600-${MIN}*60 ))
          echo "BUILD_TIME=${HOUR}æ—¶${MIN}åˆ†${SEC}ç§’" >> $GITHUB_ENV

      - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_x86_firmware_${{ env.FILE_TIME }}
          path: ./artifact/firmware/

      - name: ä¸Šä¼ targetsæ–‡ä»¶å¤¹
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_x86_targets_${{ env.FILE_TIME }}
          path: ./artifact/targets/

      - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
        if: steps.compile.outcome == 'success'
        uses: ncipollo/release-action@main
        with:
          name: ${{ env.FILE_TIME1 }} ã€Œ ${{ env.FIRMWARE_MESSAGE }} ã€
          tag: ${{ env.FILE_TIME2 }}-immortalwrt-x86
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          body: |
            â˜…  æºç  : ${{ env.REPO_URL }}
            â˜…  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜…  å›ºä»¶ç±»å‹ : ImmortalWrt 24.10.4 x86

            ğŸ–¥ å†…æ ¸ç‰ˆæœ¬ï¼š6.6

            ğŸˆ ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_TIME1 }}

            â° ç¼–è¯‘ç”¨æ—¶ï¼š${{ env.BUILD_TIME }}

            ğŸš€ ç‰¹è‰²åŠŸèƒ½ï¼šåŸºç¡€ç½‘ç»œåŠ é€Ÿ

          artifacts: ./artifact/firmware/*
