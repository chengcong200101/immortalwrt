name: Build ImmortalWrt Custom Firmware

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  FIRMWARE_NAME: ImmortalWrt-Custom-x86-64

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Check available disk space
      run: |
        echo "=== Checking disk space ==="
        df -h
        # ‰∏çÂÜçÂº∫Âà∂Ë¶ÅÊ±Ç50GBÔºåÊîπ‰∏∫Ë≠¶Âëä
        AVAILABLE_KB=$(df / --output=avail | tail -1)
        echo "Available space: $((AVAILABLE_KB / 1024 / 1024))GB"

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clean up system space
      run: |
        echo "=== Cleaning up system space ==="
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo journalctl --vacuum-size=10M
        docker system prune -af 2>/dev/null || true
        sudo rm -rf /tmp/*

    - name: Install build dependencies
      run: |
        echo "=== Installing build dependencies ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          subversion \
          quilt \
          libelf-dev
        sudo apt-get clean

    - name: Clone ImmortalWrt source
      run: |
        echo "=== Cloning ImmortalWrt source ==="
        # ‰ΩøÁî®ÁâπÂÆöÂàÜÊîØÊàñÊ†áÁ≠æ‰ª•ÂáèÂ∞ë‰∏çÁ°ÆÂÆöÊÄß
        git clone https://github.com/immortalwrt/immortalwrt.git --depth=1 --branch=openwrt-23.05
        cd immortalwrt
        echo "Source cloned successfully"

    - name: Update and install feeds
      run: |
        echo "=== Updating and installing feeds ==="
        cd immortalwrt
        
        # ÂàÜÊ≠•Êõ¥Êñ∞feedsÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÂç†Áî®Â§™Â§öËµÑÊ∫ê
        ./scripts/feeds update packages
        ./scripts/feeds update luci
        ./scripts/feeds update routing
        ./scripts/feeds update telephony
        
        ./scripts/feeds install -a
        echo "Feeds installed successfully"

    - name: Create optimized configuration
      run: |
        echo "=== Creating optimized configuration ==="
        cd immortalwrt
        
        # ‰ΩøÁî®ÈÄêË°åechoÂàõÂª∫ÈÖçÁΩÆÔºåÈÅøÂÖçÂ§çÊùÇÁöÑheredoc
        echo "CONFIG_TARGET_x86=y" > .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "" >> .config
        
        # ÈïúÂÉèÈÖçÁΩÆ
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "" >> .config
        
        # Âü∫Á°ÄÁ≥ªÁªü
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_fdisk=y" >> .config
        echo "" >> .config
        
        # ÊúÄÂ∞èÂåñÂÜÖÊ†∏Ê®°Âùó
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        echo "" >> .config
        
        # ÁΩëÁªúÂü∫Á°Ä
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_ppp=y" >> .config
        echo "CONFIG_PACKAGE_ppp-mod-pppoe=y" >> .config
        echo "" >> .config
        
        # LUCIÂü∫Á°Ä
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "" >> .config
        
        # ÊÇ®ÈúÄË¶ÅÁöÑÊâÄÊúâÊèí‰ª∂ - ÂàÜÊâπÊ∑ªÂä†
        echo "# Ê†∏ÂøÉÊèí‰ª∂" >> .config
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        echo "" >> .config
        
        echo "# DNSÁõ∏ÂÖ≥" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns-go=y" >> .config
        echo "" >> .config
        
        echo "# Á≥ªÁªüÂ∑•ÂÖ∑" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-netdata=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoupdate=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-package-manager=y" >> .config
        echo "" >> .config
        
        echo "# ÁΩëÁªú‰ºòÂåñ" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
        echo "" >> .config
        
        echo "# ‰∏ªÈ¢ò" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "" >> .config
        
        # Êèí‰ª∂‰æùËµñ
        echo "# ‰æùËµñÂåÖ" >> .config
        echo "CONFIG_PACKAGE_adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_smartdns=y" >> .config
        echo "CONFIG_PACKAGE_ddns-go=y" >> .config
        echo "CONFIG_PACKAGE_ttyd=y" >> .config
        echo "CONFIG_PACKAGE_zerotier=y" >> .config
        echo "CONFIG_PACKAGE_vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_netdata=y" >> .config
        echo "CONFIG_PACKAGE_wol=y" >> .config
        echo "CONFIG_PACKAGE_miniupnpd=y" >> .config
        echo "" >> .config
        
        # ÁºñËØëËÆæÁΩÆ
        echo "CONFIG_CCACHE=y" >> .config
        
        echo "Configuration created successfully"

    - name: Download package sources
      run: |
        echo "=== Downloading package sources ==="
        cd immortalwrt
        
        make defconfig
        
        # ÂàÜÊâπÊ¨°‰∏ãËΩΩÔºåÈÅøÂÖçÁΩëÁªúÈóÆÈ¢ò
        for i in 1 2 3; do
          echo "Download attempt $i"
          make download -j2
          if [ $? -eq 0 ]; then
            echo "Download successful"
            break
          fi
          sleep 10
        done

    - name: Build toolchain
      run: |
        echo "=== Building toolchain ==="
        cd immortalwrt
        
        # Âè™ÊûÑÂª∫Â∑•ÂÖ∑ÈìæÔºåËäÇÁúÅÁ©∫Èó¥
        make toolchain/compile -j2

    - name: Build firmware with limited resources
      timeout-minutes: 180
      run: |
        echo "=== Building firmware ==="
        cd immortalwrt
        
        echo "Disk space before build:"
        df -h
        
        # ‰ΩøÁî®ÂçïÁ∫øÁ®ãÁºñËØëÔºåÂáèÂ∞ëÂÜÖÂ≠òÂíåÁ£ÅÁõò‰ΩøÁî®
        echo "Starting single-threaded build to save resources..."
        make -j1 V=s 2>&1 | tee build.log || {
          echo "First build attempt failed, trying with clean build..."
          make clean
          make -j1 V=s 2>&1 | tee build.log
        }
        
        echo "=== Checking build results ==="
        if ls bin/targets/x86/64/*.img.gz 1> /dev/null 2>&1; then
          echo "Firmware build successful!"
          ls -la bin/targets/x86/64/
          echo "FIRMWARE_BUILT=true" >> $GITHUB_ENV
        else
          echo "Firmware build failed"
          echo "FIRMWARE_BUILT=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Upload firmware artifacts
      if: env.FIRMWARE_BUILT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          immortalwrt/bin/targets/x86/64/*.img.gz
          immortalwrt/bin/targets/x86/64/sha256sums
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/.config
        retention-days: 7

    - name: Notify build status
      if: always()
      run: |
        if [ "$FIRMWARE_BUILT" = "true" ]; then
          echo "üéâ Build completed successfully!"
        else
          echo "‚ùå Build failed - check build logs for details"
        fi
